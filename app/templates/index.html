<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMSTERDAM SITUATION MONITOR</title>
    <link rel="stylesheet" href="/static/css/bloomberg.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="has-ticker">
    <!-- Matrix Rain Background -->
    <canvas id="matrix-rain"></canvas>

    <!-- CRT Scanlines Overlay -->
    <div class="scanlines"></div>

    <!-- News Ticker -->
    <div class="news-ticker">
        <div class="ticker-label">LIVE</div>
        <div class="ticker-content">
            <div class="ticker-scroll" id="ticker-scroll"
                 hx-get="/partial/ticker"
                 hx-trigger="load, every 60s"
                 hx-swap="innerHTML">
                <span class="ticker-item">Loading Amsterdam feeds...</span>
            </div>
        </div>
    </div>

    <div class="dashboard grid-6x3" hx-ext="sse" sse-connect="/sse/updates">
        <!-- Row 1: Map (2x2), Weather, Transit, Trains, Flights -->

        <!-- Interactive Map Panel (spans 2x2) -->
        <div class="panel panel-map" id="panel-map">
            <div class="panel-header">
                <span class="panel-title glitch">Live Map</span>
                <span class="panel-badge">REAL-TIME</span>
            </div>
            <div class="panel-content" style="padding: 0;">
                <div id="map" class="map-container"></div>
            </div>
        </div>

        <!-- Weather Panel -->
        <div class="panel" id="panel-weather">
            <div class="panel-header">
                <span class="panel-title">Weather</span>
                <span class="panel-badge">AMS</span>
            </div>
            <div class="panel-content"
                 hx-get="/partial/weather"
                 hx-trigger="sse:update[event.detail=='weather'] from:body"
                 hx-swap="innerHTML">
                {% include "partials/weather.html" %}
            </div>
        </div>

        <!-- Markets Panel (moved up) -->
        <div class="panel" id="panel-markets">
            <div class="panel-header">
                <span class="panel-title">Markets</span>
                <span class="panel-badge">LIVE</span>
            </div>
            <div class="panel-content"
                 hx-get="/partial/markets"
                 hx-trigger="sse:update[event.detail=='markets'] from:body"
                 hx-swap="innerHTML">
                {% include "partials/markets.html" %}
            </div>
        </div>

        <!-- Schiphol Flights Panel -->
        <div class="panel panel-flights" id="panel-flights">
            <div class="panel-header">
                <span class="panel-title">Flightradar24</span>
                <span class="panel-badge flight">AMS</span>
            </div>
            <div class="panel-content" style="padding: 0; position: relative;">
                {% if is_local %}
                <!-- Fallback for localhost - Flightradar24 blocks iframes on localhost -->
                <div class="flightradar-fallback" style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; background: var(--bg-panel);">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚úàÔ∏è</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Flightradar24</div>
                    <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 15px;">Embed werkt alleen op productie</div>
                    <a href="https://www.flightradar24.com/52.3676,4.9041/11" target="_blank" style="color: var(--accent-cyan); text-decoration: none; font-size: 10px; border: 1px solid var(--accent-cyan); padding: 6px 12px; border-radius: 3px;">
                        Open Flightradar24 ‚Üí
                    </a>
                </div>
                {% else %}
                <div class="flightradar-container" style="width: 100%; height: 100%; position: relative;">
                    <iframe 
                        id="flightradar-iframe"
                        src="https://www.flightradar24.com/simple_index.php?lat=52.3676&lon=4.9041&z=11"
                        width="100%" 
                        height="100%" 
                        frameborder="0"
                        style="border: none; display: block; min-height: 300px;"
                        allowfullscreen
                        onerror="this.style.display='none'; document.querySelector('.flightradar-error').style.display='flex';">
                    </iframe>
                    <div class="flightradar-error" style="display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; background: var(--bg-panel);">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">Flightradar24 niet beschikbaar</div>
                        <a href="https://www.flightradar24.com/52.3676,4.9041/11" target="_blank" style="color: var(--accent-cyan); text-decoration: none; font-size: 10px;">
                            Open in nieuwe tab ‚Üí
                        </a>
                    </div>
                    <div class="flightradar-overlay" style="position: absolute; top: 5px; right: 5px; background: rgba(0, 0, 0, 0.8); padding: 4px 8px; border-radius: 3px; font-size: 8px; color: var(--text-muted); z-index: 1000; pointer-events: none;">
                        <span class="status-dot online" style="margin-right: 4px;"></span>LIVE
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Row 2: (Map continues), News, P2000 Emergency, Cameras, Extra -->

        <!-- Dutch News Panel -->
        <div class="panel" id="panel-news">
            <div class="panel-header">
                <span class="panel-title">NL News</span>
                <span class="panel-badge">NOS</span>
            </div>
            <div class="panel-content"
                 hx-get="/partial/news"
                 hx-trigger="sse:update[event.detail=='news'] from:body"
                 hx-swap="innerHTML">
                {% include "partials/news.html" %}
            </div>
        </div>

        <!-- P2000 Emergency Scanner Panel -->
        <div class="panel panel-emergency" id="panel-emergency">
            <div class="panel-header">
                <span class="panel-title"><span class="status-dot online"></span>P2000 Scanner</span>
                <span class="panel-badge emergency">LIVE</span>
            </div>
            <div class="panel-content"
                 hx-get="/partial/emergency"
                 hx-trigger="load, every 30s"
                 hx-swap="innerHTML">
                <div class="loading">Scanning emergency frequencies...</div>
            </div>
        </div>

        <!-- Live Cameras Panel 1 -->
        <div class="panel" id="panel-cameras">
            <div class="panel-header">
                <span class="panel-title">Live Cameras</span>
                <span class="panel-badge camera">CAM 1</span>
            </div>
            <div class="panel-content" style="padding: 0;"
                 hx-get="/partial/cameras"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="camera-container">
                    <div class="loading" style="padding: 10px;">Loading cameras...</div>
                </div>
            </div>
        </div>

        <!-- Live Cameras Panel 2 -->
        <div class="panel" id="panel-cameras2">
            <div class="panel-header">
                <span class="panel-title">Live Cameras</span>
                <span class="panel-badge camera">CAM 2</span>
            </div>
            <div class="panel-content" style="padding: 0;"
                 hx-get="/partial/cameras2"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="camera-container">
                    <div class="loading" style="padding: 10px;">Loading cameras...</div>
                </div>
            </div>
        </div>

        <!-- System Status Panel -->
        <div class="panel" id="panel-system">
            <div class="panel-header">
                <span class="panel-title">System</span>
                <span class="panel-badge">SYS</span>
            </div>
            <div class="panel-content">
                <div style="text-align: center; padding: 15px;">
                    <div style="font-size: 20px; color: var(--accent-cyan); margin-bottom: 8px;">AMSTERDAM</div>
                    <div style="font-size: 9px; color: var(--text-muted);">SITUATION MONITOR v2.0</div>
                    <div style="font-size: 8px; color: var(--text-dim); margin-top: 12px;">
                        <span class="status-dot online"></span> All systems operational
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Bikes, Air Quality, Parking, Extra panels -->

        <!-- Cycling Panel -->
        <div class="panel" id="panel-bikes">
            <div class="panel-header">
                <span class="panel-title">Cycling</span>
                <span class="panel-badge bike">BIKE</span>
            </div>
            <div class="panel-content"
                 hx-get="/partial/bikes"
                 hx-trigger="sse:update[event.detail=='bikes'] from:body"
                 hx-swap="innerHTML">
                {% include "partials/bikes.html" %}
            </div>
        </div>

        <!-- Air Quality Panel -->
        <div class="panel" id="panel-air-quality">
            <div class="panel-header">
                <span class="panel-title">Air Quality</span>
                <span class="panel-badge">EU AQI</span>
            </div>
            <div class="panel-content"
                 hx-get="/partial/air_quality"
                 hx-trigger="sse:update[event.detail=='air_quality'] from:body"
                 hx-swap="innerHTML">
                {% include "partials/air_quality.html" %}
            </div>
        </div>

        <!-- Parking Panel -->
        <div class="panel" id="panel-parking">
            <div class="panel-header">
                <span class="panel-title">Parking</span>
                <span class="panel-badge">P+R</span>
            </div>
            <div class="panel-content"
                 hx-get="/partial/parking"
                 hx-trigger="sse:update[event.detail=='parking'] from:body"
                 hx-swap="innerHTML">
                {% include "partials/parking.html" %}
            </div>
        </div>
    </div>

    <div class="clock-widget">
        <div class="clock-time" id="clock">--:--:--</div>
        <div id="clock-date">---</div>
    </div>

    <script>
        // Clock
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = now.toLocaleDateString('nl-NL', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
            document.getElementById('clock').textContent = timeStr;
            document.getElementById('clock-date').textContent = dateStr;
        }
        updateClock();
        setInterval(updateClock, 1000);

        // Matrix Rain Effect
        const canvas = document.getElementById('matrix-rain');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const chars = '„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥0123456789ABCDEF';
        const charArray = chars.split('');
        const fontSize = 14;
        const columns = canvas.width / fontSize;
        const drops = [];

        for (let i = 0; i < columns; i++) {
            drops[i] = Math.random() * -100;
        }

        function drawMatrix() {
            ctx.fillStyle = 'rgba(10, 10, 10, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#00ff00';
            ctx.font = fontSize + 'px monospace';

            for (let i = 0; i < drops.length; i++) {
                const char = charArray[Math.floor(Math.random() * charArray.length)];
                ctx.fillText(char, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        setInterval(drawMatrix, 50);

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Initialize Leaflet Map with real-time transit
        document.addEventListener('DOMContentLoaded', function() {
            const map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([52.3676, 4.9041], 13);

            // Dark theme tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);

            // Landmark markers
            const landmarks = [
                { lat: 52.3791, lng: 4.8980, title: 'Centraal Station', type: 'transit' },
                { lat: 52.3702, lng: 4.8952, title: 'Dam Square', type: 'landmark' },
                { lat: 52.3080, lng: 4.7621, title: 'Schiphol Airport', type: 'airport' }
            ];

            landmarks.forEach(m => {
                const color = m.type === 'transit' ? '#00cccc' : m.type === 'airport' ? '#ffcc00' : '#ff00ff';
                L.circleMarker([m.lat, m.lng], {
                    radius: 6,
                    fillColor: color,
                    color: color,
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`<b>${m.title}</b>`);
            });

            // Layers for different data
            let vehicleLayer = L.layerGroup().addTo(map);
            let emergencyLayer = L.layerGroup().addTo(map);

            // Vehicle icons
            const vehicleIcons = {
                'tram': L.divIcon({
                    html: '<div class="vehicle-icon tram">üöä</div>',
                    className: 'vehicle-div-icon',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                }),
                'metro': L.divIcon({
                    html: '<div class="vehicle-icon metro">üöá</div>',
                    className: 'vehicle-div-icon',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                }),
                'bus': L.divIcon({
                    html: '<div class="vehicle-icon bus">üöå</div>',
                    className: 'vehicle-div-icon',
                    iconSize: [18, 18],
                    iconAnchor: [9, 9]
                }),
                'ferry': L.divIcon({
                    html: '<div class="vehicle-icon ferry">‚õ¥Ô∏è</div>',
                    className: 'vehicle-div-icon',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            };

            // Colors for popups
            const vehicleColors = {
                'tram': '#ff6600',
                'metro': '#0088ff',
                'bus': '#00cc00',
                'ferry': '#00cccc'
            };

            // Colors for emergency types
            const emergencyColors = {
                'fire': '#ff0000',
                'ambulance': '#ff9900',
                'police': '#0066ff'
            };

            // Fetch and update vehicle positions
            async function updateVehicles() {
                try {
                    const response = await fetch('/api/map/vehicles');
                    const data = await response.json();

                    vehicleLayer.clearLayers();

                    data.vehicles.forEach(v => {
                        const icon = vehicleIcons[v.type] || vehicleIcons['bus'];
                        const color = vehicleColors[v.type] || '#ffffff';

                        const marker = L.marker([v.lat, v.lng], { icon: icon });

                        const delayText = v.delay > 0 ? ` <span style="color:#ff3333">(+${v.delay}min)</span>` : '';
                        const emoji = v.type === 'tram' ? 'üöä' : v.type === 'metro' ? 'üöá' : v.type === 'ferry' ? '‚õ¥Ô∏è' : 'üöå';

                        marker.bindPopup(`
                            <b style="color:${color}">${emoji} ${v.type.toUpperCase()} ${v.line}</b>${delayText}<br>
                            ‚Üí ${v.destination}<br>
                            <small style="color:#888">${v.operator}</small>
                        `);

                        vehicleLayer.addLayer(marker);
                    });
                } catch (e) {
                    console.error('Failed to fetch vehicles:', e);
                }
            }

            // Emergency icons
            const emergencyIcons = {
                'fire': L.divIcon({
                    html: '<div class="emergency-icon fire">üöí</div>',
                    className: 'emergency-div-icon',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                }),
                'ambulance': L.divIcon({
                    html: '<div class="emergency-icon ambulance">üöë</div>',
                    className: 'emergency-div-icon',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                }),
                'police': L.divIcon({
                    html: '<div class="emergency-icon police">üöî</div>',
                    className: 'emergency-div-icon',
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                })
            };

            // Fetch and update P2000 emergency incidents
            async function updateEmergencies() {
                try {
                    const response = await fetch('/api/emergency');
                    const data = await response.json();

                    emergencyLayer.clearLayers();

                    data.incidents.forEach(inc => {
                        if (inc.lat && inc.lng) {
                            const icon = emergencyIcons[inc.type] || emergencyIcons['ambulance'];
                            const color = emergencyColors[inc.type] || '#ff0000';

                            const marker = L.marker([inc.lat, inc.lng], { icon: icon });

                            const typeLabel = inc.type === 'fire' ? 'üöí BRAND' :
                                            inc.type === 'ambulance' ? 'üöë AMBULANCE' : 'üöî POLITIE';

                            marker.bindPopup(`
                                <div style="min-width: 180px;">
                                    <b style="color:${color}; font-size: 13px;">${typeLabel}</b><br>
                                    <span style="font-size: 11px;">${inc.text}</span><br>
                                    <small style="color: #888;">${inc.location} - ${inc.time}</small>
                                </div>
                            `);

                            emergencyLayer.addLayer(marker);
                        }
                    });

                    console.log(`Map: ${data.incidents.length} emergencies`);
                } catch (e) {
                    console.error('Failed to fetch emergencies:', e);
                }
            }

            // Add legend to map
            const legend = L.control({position: 'bottomleft'});
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'map-legend');
                div.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px; color: #fff;">LEGEND</div>
                    <div style="font-size: 9px; color: #888; margin-bottom: 4px;">‚Äî OV ‚Äî</div>
                    <div class="map-legend-item"><span style="margin-right: 6px;">üöä</span> Tram</div>
                    <div class="map-legend-item"><span style="margin-right: 6px;">üöá</span> Metro</div>
                    <div class="map-legend-item"><span style="margin-right: 6px;">‚õ¥Ô∏è</span> Ferry</div>
                    <div style="border-top: 1px solid #333; margin: 5px 0;"></div>
                    <div style="font-size: 9px; color: #888; margin-bottom: 4px;">‚Äî P2000 ‚Äî</div>
                    <div class="map-legend-item"><span style="margin-right: 6px;">üöí</span> Brand</div>
                    <div class="map-legend-item"><span style="margin-right: 6px;">üöë</span> Ambulance</div>
                    <div class="map-legend-item"><span style="margin-right: 6px;">üöî</span> Politie</div>
                `;
                return div;
            };
            legend.addTo(map);

            // Initial load and refresh intervals
            updateVehicles();
            updateEmergencies();
            setInterval(updateVehicles, 10000);
            setInterval(updateEmergencies, 30000);

            // Pulse effect
            setInterval(() => {
                document.querySelectorAll('.leaflet-interactive').forEach(el => {
                    el.style.filter = el.style.filter === 'brightness(1.3)' ? 'brightness(1)' : 'brightness(1.3)';
                });
            }, 1000);
        });

        // P2000 Postcode Notification System
        (function() {
            let userPostcode = localStorage.getItem('p2000_postcode') || '';
            let lastIncidentIds = new Set();
            let notificationPermission = Notification.permission;

            // Postcode configuration UI
            function initPostcodeConfig() {
                const configDiv = document.createElement('div');
                configDiv.className = 'postcode-config';
                configDiv.innerHTML = `
                    <span style="color: var(--text-muted);">Postcode:</span>
                    <input type="text" id="postcode-input" placeholder="1234AB" maxlength="6" 
                           value="${userPostcode}" pattern="[0-9]{4}[A-Z]{2}" 
                           style="text-transform: uppercase;">
                    <button onclick="savePostcode()">Opslaan</button>
                `;
                document.body.appendChild(configDiv);

                // Auto-format postcode input
                const input = document.getElementById('postcode-input');
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').toUpperCase();
                    if (value.length > 4) {
                        value = value.slice(0, 4) + ' ' + value.slice(4, 6);
                    }
                    e.target.value = value;
                });

                // Request notification permission on first load
                if (notificationPermission === 'default') {
                    Notification.requestPermission().then(permission => {
                        notificationPermission = permission;
                    });
                }
            }

            window.savePostcode = function() {
                const input = document.getElementById('postcode-input');
                let postcode = input.value.replace(/\s/g, '').toUpperCase();
                
                // Validate format
                if (/^\d{4}[A-Z]{2}$/.test(postcode)) {
                    userPostcode = postcode;
                    localStorage.setItem('p2000_postcode', postcode);
                    showToast('Postcode opgeslagen: ' + postcode);
                    // Check current incidents immediately
                    checkIncidentsForPostcode();
                } else {
                    showToast('Ongeldige postcode. Gebruik formaat: 1234AB', true);
                }
            };

            function showToast(message, error = false) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    right: 20px;
                    background: ${error ? 'rgba(255, 51, 51, 0.95)' : 'rgba(0, 204, 204, 0.95)'};
                    color: var(--text-secondary);
                    padding: 10px 15px;
                    border-radius: 4px;
                    font-size: 11px;
                    z-index: 10001;
                    animation: slideInRight 0.3s ease-out;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideOutRight 0.3s ease-out forwards';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            function showNotification(incident) {
                const icon = incident.type === 'fire' ? 'üöí' : 
                            incident.type === 'ambulance' ? 'üöë' : 'üöî';
                const typeLabel = incident.type === 'fire' ? 'BRAND' :
                                 incident.type === 'ambulance' ? 'AMBULANCE' : 'POLITIE';
                const color = incident.type === 'fire' ? '#ff0000' :
                             incident.type === 'ambulance' ? '#ff9900' : '#0066ff';

                // Browser notification
                if (notificationPermission === 'granted') {
                    new Notification(`P2000 Alert: ${typeLabel}`, {
                        body: `${incident.text}\n${incident.location}${incident.postcode ? ' - ' + incident.postcode : ''}`,
                        icon: '/static/favicon.ico',
                        tag: `p2000-${incident.postcode}-${incident.time}`,
                        requireInteraction: true
                    });
                }

                // UI popup
                const popup = document.createElement('div');
                popup.className = 'notification-popup';
                popup.style.borderColor = color;
                popup.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-icon">${icon}</span>
                        <span class="notification-title">P2000 ALERT - ${typeLabel}</span>
                        <span class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</span>
                    </div>
                    <div class="notification-body">
                        ${incident.text}<br>
                        <span class="notification-location">${incident.location}</span>
                        ${incident.postcode ? `<span class="notification-postcode">${incident.postcode}</span>` : ''}
                    </div>
                    <div class="notification-time">${incident.time}</div>
                `;
                document.body.appendChild(popup);

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (popup.parentElement) {
                        popup.classList.add('hide');
                        setTimeout(() => popup.remove(), 300);
                    }
                }, 10000);
            }

            function checkIncidentsForPostcode() {
                if (!userPostcode) return;

                fetch('/api/emergency')
                    .then(res => res.json())
                    .then(data => {
                        const currentIncidentIds = new Set();
                        
                        data.incidents.forEach(inc => {
                            // Create unique ID for incident
                            const incidentId = `${inc.postcode || 'no-pc'}-${inc.time}-${inc.text.substring(0, 20)}`;
                            currentIncidentIds.add(incidentId);

                            // Check if this is a new incident matching user's postcode
                            if (inc.postcode && inc.postcode === userPostcode && !lastIncidentIds.has(incidentId)) {
                                showNotification(inc);
                            }
                        });

                        lastIncidentIds = currentIncidentIds;
                    })
                    .catch(err => console.error('Failed to check incidents:', err));
            }

            // Initialize on page load
            initPostcodeConfig();
            
            // Check incidents every 30 seconds (same as emergency panel refresh)
            if (userPostcode) {
                checkIncidentsForPostcode();
                setInterval(checkIncidentsForPostcode, 30000);
            }

            // Also check when emergency panel updates via HTMX
            document.body.addEventListener('htmx:afterSwap', function(event) {
                if (event.detail.target.id === 'panel-emergency' || 
                    event.detail.target.closest('#panel-emergency')) {
                    setTimeout(checkIncidentsForPostcode, 1000);
                }
            });
        })();
    </script>
</body>
</html>
